@Library('singularity_template@main') _

properties([
    parameters([
        booleanParam(name: 'forceRebuild', defaultValue: false, description: 'Force rebuild of the Singularity image'),
        string(name: 'buildTime', defaultValue: '00:30:00', description: 'Build job time limit'),
        string(name: 'buildCPUs', defaultValue: '8', description: 'CPUs to allocate for build'),
        string(name: 'buildMem', defaultValue: '10G', description: 'Memory to allocate for build'),
        string(name: 'runTime', defaultValue: '06:00:00', description: 'Run job time limit'),
        string(name: 'runCPUs', defaultValue: '4', description: 'CPUs to allocate for run'),
        string(name: 'runMem', defaultValue: '14G', description: 'Memory to allocate for run'),
        string(name: 'binds', defaultValue: '/home/wlp9800/.gnupg,/home/wlp9800/dev/asteroids:/home/wlp9800/asteroids', description: 'Bind paths for Singularity'),
        booleanParam(name: 'useGpu', defaultValue: false, description: 'Use GPU in the Singularity container'),
        booleanParam(name: 'exclusive', defaultValue: true, description: 'Run with exclusive node access')
    ])
])

def defaults = [
    sshUser: 'wlp9800',
    image: 'haskell-devenv',
    scratchDir: '/scratch/wlp9800',
    logDir: '/vast/wlp9800/logs',
    dockerUrl: 'docker://thewillyp/haskell-devenv',
    overlaySrc: '/scratch/wlp9800/haskell-devenv.ext3',
    entrypointUrl: 'https://raw.githubusercontent.com/thewillyP/haskell-devenv/master/entrypoint.sh',
    forceRebuild: params.forceRebuild,
    buildTime: params.buildTime,
    buildCPUs: params.buildCPUs,
    buildMem: params.buildMem,
    runTime: params.runTime,
    runCPUs: params.runCPUs,
    runMem: params.runMem,
    binds: params.binds,
    useGpu: params.useGpu,
    exclusive: params.exclusive
]

pipeline {
    agent any

    stages {
        stage('Checkout Scripts') {
            steps {
                checkout([
                    $class: 'GitSCM',
                    branches: [[name: '*/main']],
                    userRemoteConfigs: [[url: 'https://github.com/thewillyP/jenkins.git']]
                ])
                script {
                    env.EXEC_HOST = sh(script: "hostname", returnStdout: true).trim()
                    sh """
                    ssh -o StrictHostKeyChecking=no ${defaults.sshUser}@${env.EXEC_HOST} 'mkdir -p /tmp/jenkins_scripts'
                    scp -o StrictHostKeyChecking=no submit_dns_job.sh ${defaults.sshUser}@${env.EXEC_HOST}:/tmp/jenkins_scripts/
                    """
                }
            }
        }

        stage('Detect Hostname') {
            steps {
                script {
                    env.EXEC_HOST = sh(script: "hostname", returnStdout: true).trim()
                    echo "Executor host: ${env.EXEC_HOST}"
                }
            }
        }

        stage('Run Singularity Pipeline') {
            steps {
                script {
                    def runJobId = singularityPipeline(defaults)
                    echo "Singularity run job id: ${runJobId}"
                    env.RUN_JOB_ID = runJobId
                }
            }
        }

        stage('Submit DNS Update Job') {
            steps {
                script {
                    sh """
                    ssh -o StrictHostKeyChecking=no ${defaults.sshUser}@${env.EXEC_HOST} \\
                    'bash /tmp/jenkins_scripts/submit_dns_job.sh \\
                    ${env.RUN_JOB_ID} ${defaults.image} ${defaults.logDir} dns-update-${defaults.image} 1G 00:05:00 1 ${defaults.sshUser}'
                    """
                }
            }
        }

        stage('Cleanup Remote Scripts') {
            steps {
                script {
                    sh """
                    ssh -o StrictHostKeyChecking=no ${defaults.sshUser}@${env.EXEC_HOST} 'rm -rf /tmp/jenkins_scripts'
                    """
                }
            }
        }
    }
}