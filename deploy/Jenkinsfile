@Library('singularity_template@main') _

properties([
    parameters([
        booleanParam(
            name: 'forceRebuild',
            defaultValue: false,
            description: 'Force rebuild of the Singularity image'
        )
    ])
])

def defaults = [
    sshUser: 'wlp9800',
    image: 'haskell-devenv',
    scratchDir: '/scratch/wlp9800',
    logDir: '/vast/wlp9800/logs',
    dockerUrl: 'docker://thewillyp/haskell-devenv',
    forceRebuild: params.forceRebuild,
    overlaySrc: '/scratch/wlp9800/haskell-devenv.ext3',
    buildTime: '00:30:00',
    buildCPUs: '8',
    buildMem: '10G',
    runTime: '06:00:00',
    runCPUs: '4',
    runMem: '14G',
    entrypointUrl: 'https://raw.githubusercontent.com/thewillyP/haskell-devenv/master/entrypoint.sh',
    binds: "/home/wlp9800/dev/asteroids:/home/wlp9800/asteroids",
    useGpu: false 
]

pipeline {
    agent any

    stages {
        stage('Detect Hostname') {
            steps {
                script {
                    env.EXEC_HOST = sh(script: "hostname", returnStdout: true).trim()
                    echo "Executor host: ${env.EXEC_HOST}"
                }
            }
        }

        stage('Run Singularity Pipeline') {
            steps {
                script {
                    def runJobId = singularityPipeline(defaults)
                    echo "Singularity run job id: ${runJobId}"
                    env.RUN_JOB_ID = runJobId
                }
            }
        }

        stage('Submit DNS Update Job') {
            steps {
                script {
                    sh """
                    ssh -o StrictHostKeyChecking=no ${defaults.sshUser}@${env.EXEC_HOST} \\
                      'curl -fsSL https://raw.githubusercontent.com/thewillyP/jenkins/main/submit_dns_job.sh | \\
                      bash -s ${env.RUN_JOB_ID} ${defaults.image} ${defaults.logDir} dns-update-${defaults.image} 1G 00:05:00 1 ${defaults.sshUser}'
                    """
                }
            }
        }
    }
}
